<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <script type="text/javascript" src="../Scripts/jquery-1.6.4.min.js"></script>
</head>
<body>
    <h1 id="versionHeadLine">Analyze Your Pages</h1>
    <div id="anokcoApp">
        <div>Use the dropdowns to select a different period and date to view. You must have Live Edit turned off to use the dropdowns.</div>
        <div id="anokcoControls"></div>
        <div id="anokcoUrlInput"></div>
        <div id="anokcoMessage"></div>
        <div id="anokcoUrlReport"></div>
    </div>

    <script type="text/javascript">
        //setup main object to define app
        var ANOKCO = ANOKCO || {};
        //setup constant values for the app
        ANOKCO["theApp"] = "#anokcoApp";             //div for the whole app
        ANOKCO["theMessage"] = "#anokcoMessage";     //div for the message
        ANOKCO["theControls"] = "#anokcoControls";   //div for the controls
        ANOKCO["theUrlInput"] = "#anokcoUrlInput";   //div for the URL input controls
        ANOKCO["theUrlReport"] = "#anokcoUrlReport";   //div for the URL output
        ANOKCO["theHeadline"] = "#versionHeadLine";  //id of the H1 element for the page, by CivicPlus
        ANOKCO["theStartDate"] = new Date(2014, 3, 8); //Date object for April 8, 2014, the first valid date of stats
        ANOKCO["theNowDate"] = new Date();
        //Date object for current date minus one day, the last valid date of stats, if date is 0 that creates last day of previous month
        ANOKCO["theEndDate"] = new Date(ANOKCO.theNowDate.getFullYear(), ANOKCO.theNowDate.getMonth(), ANOKCO.theNowDate.getDate() - 1);
        //RegExp is from http://stackoverflow.com/questions/8188645/javascript-regex-to-match-a-url-in-a-field-of-text
        ANOKCO["theUrlRegExp"] = new RegExp('(http|ftp|https)://[a-z0-9\-_]+(\.[a-z0-9\-_]+)+([a-z0-9\-\.,@\?^=%&;:/~\+#]*[a-z0-9\-@\?^=%&;/~\+#])?', 'i');

        //setup main objects for organizing data and code
        ANOKCO["VIEW"] = {};
        ANOKCO["LOGIC"] = {};
        ANOKCO["DATA"] = {};

        //setup and fill DATA objects used in the JSON request to PIWIK
        ANOKCO["theURL"] = "https://analytics.civicplus.com/index.php"; //url for analyzing user list of pages
        ANOKCO.DATA["PARAMETERS"] = {};         //object for all name-value pairs in URL request to PIWIK
        ANOKCO.DATA.PARAMETERS["module"] = "API";
        ANOKCO.DATA.PARAMETERS["method"] = "Actions.getPageUrl";

        ANOKCO.DATA.PARAMETERS["idSite"] = "XXXX";                      //THIS IS YOUR PIWIK SITE ID
        ANOKCO.DATA.PARAMETERS["token_auth"] = "XXXX";                  //THIS IS YOUR AUTHENTICATION TOKEN

        ANOKCO.DATA.PARAMETERS["format"] = "JSON";
        ANOKCO.DATA.PARAMETERS["jsoncallback"] = "anokco";
        ANOKCO.DATA.PARAMETERS["period"] ="";
        ANOKCO.DATA.PARAMETERS["date"] = "";
        ANOKCO.DATA.PARAMETERS["pageUrl"] ="";


        //setup other DATA objects
        ANOKCO.DATA["parameterList"] = [];      //array list of all names in PARAMETERS, used as an index for loops
        ANOKCO.DATA["urlList"] = [];            //array of URLs to submit for analysis
        ANOKCO.DATA["urlListCount"] = 0;        //number of URLs for iterating through the list
        ANOKCO.DATA["ANALYTICS"] = [];          //object for returned analytics

        ANOKCO.VIEW.showForm = function () {
            $(ANOKCO.theControls).empty();
            $(ANOKCO.theControls).append("<form id=\"anokcoUrlForm\"></form>");
        }
        ANOKCO.VIEW.showDropdowns = function () {
            //create 4 dropdown, initialize the PeriodDropdown, leave others blank and disabled
            //start with a div for all the dropdowns
            $("#anokcoUrlForm").append("<div id=\"anokcoDropdownsHolder\"></div>");
            //add a dropdown to select the period
            $("#anokcoDropdownsHolder").append("<div id=\"anokcoPeriodDropdown\" class=\"anokcoDropdown\"></div>");
            $("#anokcoPeriodDropdown").append("<label for=\"anokcoSelectPeriod\">Time Period: </label><br />");
            $("#anokcoPeriodDropdown").append("<select id=\"anokcoSelectPeriod\"></select>");
            $("#anokcoSelectPeriod").append("<option value=\"-1\">Select a Period</option>");
            $("#anokcoSelectPeriod").append("<option value=\"month\">Month</option>");
            $("#anokcoSelectPeriod").append("<option value=\"week\">Week</option>");
            $("#anokcoSelectPeriod").append("<option value=\"day\">Day</option>");
            //add an event listener to the dropdown
            $("#anokcoSelectPeriod").change(function () { ANOKCO.VIEW.handleSelectPeriod(); });
            //add a dropdown to select from list of valid years but leave it disabled
            $("#anokcoDropdownsHolder").append("<div id=\"anokcoYearDropdown\" class=\"anokcoDropdown\"></div>");
            $("#anokcoYearDropdown").append("<label for=\"anokcoSelectYear\">Year: </label><br />");
            $("#anokcoYearDropdown").append("<select id=\"anokcoSelectYear\"></select>");
            $("#anokcoSelectYear").append("<option value=\"-1\">Select Year</option>");
            //add an event listener to the dropdown
            $("#anokcoSelectYear").change(function () { ANOKCO.VIEW.handleSelectYear(); });
            $("#anokcoSelectYear").prop("disabled", true);
            //add a dropdown to select from list of valid months for the year selected, but leave it disabled
            $("#anokcoDropdownsHolder").append("<div id=\"anokcoMonthDropdown\" class=\"anokcoDropdown\"></div>");
            $("#anokcoMonthDropdown").append("<label for=\"anokcoSelectMonth\">Month: </label><br />");
            $("#anokcoMonthDropdown").append("<select id=\"anokcoSelectMonth\"></select>");
            $("#anokcoSelectMonth").append("<option value=\"-1\">Select Month</option>");
            //add an event listener to the dropdown
            $("#anokcoSelectMonth").change(function () { ANOKCO.VIEW.handleSelectMonth(); });
            $("#anokcoSelectMonth").prop("disabled", true);
            //add a dropdown to select from list of valid dates for the selected year and month, but leave it disabled
            $("#anokcoDropdownsHolder").append("<div id=\"anokcoDateDropdown\" class=\"anokcoDropdown\"></div>");
            $("#anokcoDateDropdown").append("<label for=\"anokcoSelectDate\">Date: </label><br />");
            $("#anokcoDateDropdown").append("<select id=\"anokcoSelectDate\"></select>");
            $("#anokcoSelectDate").append("<option value=\"-1\">Select Date</option>");
            //add an event listener to the dropdown
            $("#anokcoSelectDate").change(function () { ANOKCO.VIEW.handleSelectDate(); });
            $("#anokcoSelectDate").prop("disabled", true);
        }
        ANOKCO.VIEW.showUrlControls = function () {
            $("#anokcoUrlForm").append("<div id=\"anokcoUrlControls\"></div>");
            $("#anokcoUrlControls").append("<label for=\"anokcoUrlTextArea\">Enter your list of URLs</label><br />");
            $("#anokcoUrlControls").append("<textarea id=\"anokcoUrlTextArea\" rows=\"10\" cols=\"80\"></textarea><br />");
            $("#anokcoUrlControls").append("<input id=\"anokcoUrlSubmit\" class=\"anokcoButton\" type=\"button\" value=\"Analyze Pages\" />");
            $("#anokcoUrlSubmit").prop("disabled", true);
            $("#anokcoUrlSubmit").click(ANOKCO.DATA.getUrls);
        }
        ANOKCO.VIEW.showLoading = function () {
            $(ANOKCO.theMessage).empty();
            $(ANOKCO.theMessage).append("<div class=\"anokcoTheMessage\">Loading data from PIWIK...</div>");
        }
        ANOKCO.VIEW.showPeriodDate = function () {
            //display the current period and date parameters in theMessage
            $(ANOKCO.theMessage).empty();
            var theYear;
            var theMonth;
            var theDay;
            var theDisplayDateParameter = ANOKCO.DATA.PARAMETERS["date"].split("-");
            if (theDisplayDateParameter.length > 1) {
                //date parameter was in format, yyyy-mm-dd
                var theDisplayDate = new Date(parseInt(theDisplayDateParameter[0], 10), parseInt(theDisplayDateParameter[1], 10) - 1, parseInt(theDisplayDateParameter[2], 10));
                theYear = theDisplayDate.getFullYear();
                theMonth = ANOKCO.LOGIC.getMonthName(theDisplayDate.getMonth(), "long");
                theDay = theDisplayDate.getDate();
            } else {
                //date parameter was yesterday
                theYear = ANOKCO.theEndDate.getFullYear();
                theMonth = ANOKCO.LOGIC.getMonthName(ANOKCO.theEndDate.getMonth(), "long");
                theDay = ANOKCO.theEndDate.getDate(); //theEndDate is always yesterday
            }
            switch (ANOKCO.DATA.PARAMETERS["period"]) {
                case "month":
                    $(ANOKCO.theMessage).append("<div class=\"anokcoTheMessage\">Showing <strong>" + $(ANOKCO.theHeadline).text() + "</strong> for the <strong>month</strong> of <strong>" + theMonth + ", " + theYear + "</strong></div>");
                    break;
                case "week":
                    $(ANOKCO.theMessage).append("<div class=\"anokcoTheMessage\">Showing <strong>" + $(ANOKCO.theHeadline).text() + "</strong> for the <strong>week</strong> starting on <strong>" + theMonth + " " + theDay + ", " + theYear + "</strong></div>");
                    break;
                case "day":
                    $(ANOKCO.theMessage).append("<div class=\"anokcoTheMessage\">Showing <strong>" + $(ANOKCO.theHeadline).text() + "</strong> for the <strong>day</strong> - <strong>" + theMonth + " " + theDay + ", " + theYear + "</strong></div>");
                    break;
                default:
                    break;
            }
        }

        ANOKCO.VIEW.resetSelectMonth = function () {
            $("#anokcoSelectMonth").children().remove().end().append("<option value=\"-1\">Select Month</option>");
            $("#anokcoSelectMonth").prop("disabled", true);
        }
        ANOKCO.VIEW.resetSelectDate = function () {
            $("label[for='anokcoSelectDate']").text("Date:");
            $("#anokcoSelectDate").children().remove().end().append("<option value=\"-1\">Select Date</option>");
            $("#anokcoSelectDate").prop("disabled", true);
        }

        ANOKCO.VIEW.handleSelectPeriod = function () {
            switch ($("#anokcoSelectPeriod").val().toString()) {
                case "-1":
                    //if the first option is selected, disable the other dropdowns
                    $("#anokcoSelectYear").prop("disabled", true);
                    ANOKCO.VIEW.resetSelectMonth();
                    ANOKCO.VIEW.resetSelectDate();
                    $(".anokcoButton").prop("disabled", true);
                    break;
                case "month":
                    //set the label on the date dropdown to select date
                    $("label[for='anokcoSelectDate']").text("Date:");
                    //set the year dropdown
                    ANOKCO.VIEW.setYearDropdown();
                    if ($("#anokcoSelectYear").find("option").length == 2) {
                        //if there's only 1 year, do setMonthDropdown
                        ANOKCO.VIEW.setMonthDropdown();
                        ANOKCO.VIEW.resetSelectDate();
                        $(".anokcoButton").prop("disabled", true);
                    } else {
                        //if more than 1 year, disable other dropdowns
                        ANOKCO.VIEW.resetSelectMonth();
                        ANOKCO.VIEW.resetSelectDate();
                        $(".anokcoButton").prop("disabled", true);
                    }
                    break;
                case "week":
                    //set the year dropdown
                    ANOKCO.VIEW.setYearDropdown();
                    if ($("#anokcoSelectYear").find("option").length == 2) {
                        //if there's only 1 year, do setMonthDropdown
                        ANOKCO.VIEW.setMonthDropdown();
                        ANOKCO.VIEW.resetSelectDate();
                        $(".anokcoButton").prop("disabled", true);
                    } else {
                        //if more than 1 year, disable other dropdowns
                        ANOKCO.VIEW.resetSelectMonth();
                        ANOKCO.VIEW.resetSelectDate();
                        $(".anokcoButton").prop("disabled", true);
                    }
                    //set the label on the date dropdown to select week
                    $("label[for='anokcoSelectDate']").text("Week:");
                    break;
                case "day":
                    //set the year dropdown
                    ANOKCO.VIEW.setYearDropdown();
                    if ($("#anokcoSelectYear").find("option").length == 2) {
                        //if there's only 1 year, do setMonthDropdown
                        ANOKCO.VIEW.setMonthDropdown();
                        ANOKCO.VIEW.resetSelectDate();
                        $(".anokcoButton").prop("disabled", true);
                    } else {
                        //if more than 1 year, disable other dropdowns
                        ANOKCO.VIEW.resetSelectMonth();
                        ANOKCO.VIEW.resetSelectDate();
                        $(".anokcoButton").prop("disabled", true);
                    }
                    //set the label on the date dropdown to select day
                    $("label[for='anokcoSelectDate']").text("Day:");
                    break;
                default:
                    break;
            }
        }
        ANOKCO.VIEW.handleSelectYear = function () {
            switch ($("#anokcoSelectYear").val().toString()) {
                case "-1":
                    //if the first option is selected, disable the other dropdowns
                    ANOKCO.VIEW.resetSelectMonth();
                    ANOKCO.VIEW.resetSelectDate();
                    $(".anokcoButton").prop("disabled", true);
                    break;
                default:
                    //if a year is selected, do setMonthDropdown
                    ANOKCO.VIEW.setMonthDropdown();
                    ANOKCO.VIEW.resetSelectDate();
                    break;
            }
        }
        ANOKCO.VIEW.handleSelectMonth = function () {
            switch ($("#anokcoSelectMonth").val().toString()) {
                case "-1":
                    //if the first option is selected, disable the other dropdowns
                    $("#anokcoSelectDate").prop("disabled", true);
                    $(".anokcoButton").prop("disabled", true);
                    break;
                default:
                    //if a month is selected, set the date dropdown, using week or day methods, or activate the get results button
                    switch ($("#anokcoSelectPeriod").val().toString()) {
                        case "month":
                            ANOKCO.VIEW.resetSelectDate();
                            $(".anokcoButton").prop("disabled", false); //enable the button to get results
                            break;
                        case "week":
                            ANOKCO.VIEW.setWeekDropdown();
                            $(".anokcoButton").prop("disabled", true);
                            break;
                        case "day":
                            ANOKCO.VIEW.setDayDropdown();
                            $(".anokcoButton").prop("disabled", true);
                            break;
                        default:
                            break;
                    }
                    break;
            }
        }
        ANOKCO.VIEW.handleSelectDate = function () {
            $(".anokcoButton").prop("disabled", false);
        }

        ANOKCO.VIEW.setYearDropdown = function () {
            //reset the year dropdown
            $("#anokcoSelectYear").children().remove().end().append("<option value=\"-1\">Select Year</option>");
            //remove any handlers
            //$("#anokcoSelectYear").off();
            //add values
            var yearStart = ANOKCO.theStartDate.getFullYear(); //start year
            var yearEnd = ANOKCO.theEndDate.getFullYear();
            if (yearStart == yearEnd) {
                //if there is only one year, add the yearStart, make it selected
                $("#anokcoSelectYear").append("<option value=\"" + yearStart.toString() + "\" selected>" + yearStart.toString() + "</option>");
                $("#anokcoSelectYear").prop("disabled", false);
            } else {
                //if there is more than one year, add the years, leave none selected,
                while (yearStart <= yearEnd) {
                    $("#anokcoSelectYear").append("<option value=\"" + yearStart.toString() + "\">" + yearStart.toString() + "</option>");
                    yearStart++;
                }
                $("#anokcoSelectYear").prop("disabled", false);
            }
        }
        ANOKCO.VIEW.setMonthDropdown = function () {
            //reset the month dropdown
            $("#anokcoSelectMonth").children().remove().end().append("<option value=\"-1\">Select Month</option>");
            //remove any handlers
            //$("#anokcoSelectMonth").off();
            //add values
            var yearSelect = $("#anokcoSelectYear").val();
            //to get list of valid months for the selected year, make starting and ending dates
            //for starting date, make date object using theStartDate year and month, with date=1 for beginning of month
            var yearMonthStart = new Date(ANOKCO.theStartDate.getFullYear(), ANOKCO.theStartDate.getMonth(), 1);
            //for ending date, make date object using theEndDate year, month + 1 and date = 0, which gets the last date of the month
            var yearMonthEnd = new Date(ANOKCO.theEndDate.getFullYear(), ANOKCO.theEndDate.getMonth() + 1, 0);
            //for the selected year find all valid months 0-11
            for (var i = 0; i <= 11; i++) {
                var yearMonthTry = new Date(yearSelect, i, 1);
                if ((yearMonthTry >= yearMonthStart) && (yearMonthTry <= yearMonthEnd)) {
                    $("#anokcoSelectMonth").append("<option value=\"" + i.toString() + "\">" + ANOKCO.LOGIC.getMonthName(i, "short") + "</option>");
                }
            }
            $("#anokcoSelectMonth").prop("disabled", false);
        }
        ANOKCO.VIEW.setWeekDropdown = function () {
            //reset the date dropdown
            $("#anokcoSelectDate").children().remove().end().append("<option value=\"-1\">Select Week</option>");
            //remove any handlers
            //$("#anokcoSelectDate").off();
            //for the selected year and month, find the first monday of the month
            var firstMonday = 0;
            for (var i = 1; i <= 7; i++) {
                var tryDate = new Date(parseInt($("#anokcoSelectYear").val(), 10), parseInt($("#anokcoSelectMonth").val(), 10), i)
                //try until getDay returns 1, which is Monday
                if (tryDate.getDay() == 1) {
                    firstMonday = i;
                    break;
                }
            }
            //get the last date of the selected month
            var lastDateOfMonth = new Date(parseInt($("#anokcoSelectYear").val(), 10), parseInt($("#anokcoSelectMonth").val(), 10) + 1, 0);
            //generate list of weeks in the month
            //NOTE - not testing to make sure the week is in the valid date range, list of weeks could include weeks with no data, this does not cause an error, the PIWIK widget simply says no data available
            for (var i = firstMonday; i <= lastDateOfMonth.getDate() ; i += 7) {
                var theMonday = new Date(parseInt($("#anokcoSelectYear").val(), 10), parseInt($("#anokcoSelectMonth").val(), 10), i);
                var theSunday = new Date(parseInt($("#anokcoSelectYear").val(), 10), parseInt($("#anokcoSelectMonth").val(), 10), i + 6);
                var theText = ANOKCO.LOGIC.getMonthName(theMonday.getMonth(), "short") + " " + theMonday.getDate() + " -- " + ANOKCO.LOGIC.getMonthName(theSunday.getMonth(), "short") + " " + theSunday.getDate();
                $("#anokcoSelectDate").append("<option value=\"" + i + "\">" + theText + "</option>");
            }
            $("#anokcoSelectDate").prop("disabled", false);
        }
        ANOKCO.VIEW.setDayDropdown = function () {
            //reset the date dropdown
            $("#anokcoSelectDate").children().remove().end().append("<option value=\"-1\">Select Day</option>");
            //remove any handlers
            //$("#anokcoSelectDate").off();
            //for selected year and month, get first and last dates
            var dateStart = ANOKCO.theStartDate;
            var dateEnd = ANOKCO.theEndDate;
            //to get last date of year/month, add 1 to month and use 0 as date, this works even with December
            var lastDateOfMonth = new Date(parseInt($("#anokcoSelectYear").val(), 10), parseInt($("#anokcoSelectMonth").val(), 10) + 1, 0);
            for (var i = 1; i <= lastDateOfMonth.getDate() ; i++) {
                var tryDate = new Date(parseInt($("#anokcoSelectYear").val(), 10), parseInt($("#anokcoSelectMonth").val(), 10), i);
                if (tryDate >= dateStart && tryDate <= dateEnd) {
                    $("#anokcoSelectDate").append("<option value=\"" + i + "\">" + i + "</option>");
                }
            }
            $("#anokcoSelectDate").prop("disabled", false);
        }

        ANOKCO.VIEW.showDownloadLink = function () {
            var csvRows = [];
            for (var i = 0, l = ANOKCO.DATA.ANALYTICS.length; i < l; ++i) {
                csvRows.push(ANOKCO.DATA.ANALYTICS[i].join(','));   // unquoted CSV row
            }
            var csvString = csvRows.join("%0D%0A"); //characters for carriage return, line feed
            var a = document.createElement("a");
            a.href = "data:attachment/csv," + csvString;
            a.target = "_blank";
            a.download = "analytics.csv";
            a.innerHTML = "Download data in CSV format (Chrome or Firefox only).";
            $(ANOKCO.theUrlReport).append("<div id=\"anokcoDownloadLink\"></div>");
            $("#anokcoDownloadLink").append(a);
            ANOKCO.VIEW.resize();
        }

        ANOKCO.VIEW.style = function () {
            var theBoxStyle = {
                "width": "150px",
                "padding": "10px",
                "margin-top": "10px",
                "background-color": "#cee1e1",
                "float": "left"
            };
            $(".anokcoDropdown").css(theBoxStyle);
            $(ANOKCO.theMessage).css({
                "font-size": "larger",
                "width": "100%",
                "padding": "10px",
                "clear": "both"
            });
            $("#anokcoDropdownsHolder").css({
                "width": "100%",
                "padding": "10px",
                "clear": "both"
            });
            $("#anokcoIframeControlsHolder").css({
                "width": "100%",
                "padding": "10px",
                "clear": "both"
            });
            $("#anokcoUrlControls").css({
                "width": "100%",
                "padding": "10px",
                "clear": "both"
            });
            $(".anokcoCell").css({
                "padding": "5px",
            });
        };
        ANOKCO.VIEW.resize = function () {
            //resize the CivicPlus page to accomodate the height of the app
            var newPageHeight = $(ANOKCO["theApp"]).height() + 200;
            $("#structuralContainer1").css({
                "min-height": newPageHeight + "px"
            });
        }

        ANOKCO.DATA.getUrls = function () {
            //get the list of urls to analyze that user has entered and start the process of analyzing them
            //clear the ANALYTICS arraly
            ANOKCO.DATA.ANALYTICS.length = 0;
            //clear the urlList array
            ANOKCO.DATA.urlList.length = 0;
            //put the urls entered into the text area into the array
            ANOKCO.DATA.urlList = $("#anokcoUrlTextArea").val().split("\n");
            //depending on period selected, get new values for period and date
            switch ($("#anokcoSelectPeriod").val()) {
                case "month":
                    ANOKCO.DATA.PARAMETERS["period"] = "month";
                    ANOKCO.DATA.PARAMETERS["date"] = $("#anokcoSelectYear").val().toString() + "-" + (parseInt($("#anokcoSelectMonth").val(), 10) + 1).toString() + "-1";
                    break;
                case "week":
                    ANOKCO.DATA.PARAMETERS["period"] = "week";
                    ANOKCO.DATA.PARAMETERS["date"] = $("#anokcoSelectYear").val().toString() + "-" + (parseInt($("#anokcoSelectMonth").val(), 10) + 1).toString() + "-" + $("#anokcoSelectDate").val().toString();
                    break;
                case "day":
                    ANOKCO.DATA.PARAMETERS["period"] = "day";
                    ANOKCO.DATA.PARAMETERS["date"] = $("#anokcoSelectYear").val().toString() + "-" + (parseInt($("#anokcoSelectMonth").val(), 10) + 1).toString() + "-" + $("#anokcoSelectDate").val().toString();
                    break;
                default:
                    break;
            }
            //display the period and date for the report
            ANOKCO.VIEW.showPeriodDate();
            //start the table for results
            $(ANOKCO.theUrlReport).empty();
            $(ANOKCO.theUrlReport).append("<table id=\"anokcoResults\"></table>");
            $("#anokcoResults").append("<tr><th class=\"anokcoCell\">PAGE URL</th><th class=\"anokcoCell\">PAGEVIEWS</th></tr>");
            ANOKCO.DATA.urlListCount = 0;
            //set the header row for the data download
            var theNumberHeader = ANOKCO.DATA.PARAMETERS["period"] + "(" + ANOKCO.DATA.PARAMETERS["date"] + ")";
            ANOKCO.DATA.ANALYTICS.push(["PAGE URL", theNumberHeader]);
            ANOKCO.DATA.getAnalytics();
        }
        ANOKCO.DATA.getAnalytics = function () {
            //loop through the list of URLs, not using the loop structure because of the async AJAX calls to PIWIK
            //want a call to PIWIK to return a result for a URL before going on to the next URL
            if (ANOKCO.DATA.urlListCount >=  ANOKCO.DATA.urlList.length) {
                //done, finish by adding the link to data
                ANOKCO.VIEW.showDownloadLink();
                //style and resize the app one last time
                ANOKCO.VIEW.style();
                ANOKCO.VIEW.resize();
            } else {
                if (ANOKCO.DATA.urlList[ANOKCO.DATA.urlListCount].length == 0) {
                    //skip any blank lines in the list of urls
                    ANOKCO.DATA.urlListCount++;
                    ANOKCO.DATA.getAnalytics();
                } else if (!ANOKCO.theUrlRegExp.test(ANOKCO.DATA.urlList[ANOKCO.DATA.urlListCount])) {
                    // test for web page address pattern, alert the user if not a url then skip
                    alert("\"" + ANOKCO.DATA.urlList[ANOKCO.DATA.urlListCount] + "\" is not a web page address and will not be included in the analysis");
                    ANOKCO.DATA.urlListCount++;
                    ANOKCO.DATA.getAnalytics();
                } else {
                    //process each url into parts
                    var arrUrl = ANOKCO.DATA.urlList[ANOKCO.DATA.urlListCount].split("/");
                    // assume arrUrl is 
                    //     [protocol:,,server,pagenumber,pagetitleabbrv] or
                    //     [protocol:,,server,filename and query]
                    // make the parameter that PIWIK needs for analysis
                    var urlParameter = "/" + arrUrl[3].toString();
                    if (arrUrl.length > 4) {
                        urlParameter += "/" + arrUrl[4].toString().toLowerCase();
                    }
                    //add pageUrl value to PARAMETERS
                    ANOKCO.DATA.PARAMETERS["pageUrl"] = urlParameter;
                    $.ajax({
                        type: "POST",
                        url: ANOKCO.theURL,
                        data: ANOKCO.DATA.PARAMETERS,
                        async: false,
                        jsonpCallback: "anokco",
                        contentType: "application/json",
                        dataType: "jsonp",
                        beforeSend: function () {
                            //do any startup tasks here;
                        },
                        success: function (data, textStatus, xhr) {
                            if ((typeof data[0] == undefined) || (data[0] == null)) {
                                //if there is no data for that url, PIWIK returns an empty object, so data[0] is null
                                $("#anokcoResults").append("<tr><td class=\"anokcoCell\"><a href=\"" + ANOKCO.DATA.urlList[ANOKCO.DATA.urlListCount] + "\" target=\"_blank\">" + ANOKCO.DATA.urlList[ANOKCO.DATA.urlListCount] + "</td><td class=\"anokcoCell\">" + "no data" + "</td></tr>");
                                ANOKCO.DATA.ANALYTICS.push([ANOKCO.DATA.urlList[ANOKCO.DATA.urlListCount], "0"]);
                            } else {
                                $("#anokcoResults").append("<tr><td class=\"anokcoCell\"><a href=\"" + ANOKCO.DATA.urlList[ANOKCO.DATA.urlListCount] + "\" target=\"_blank\">" + ANOKCO.DATA.urlList[ANOKCO.DATA.urlListCount] + "</td><td class=\"anokcoCell\">" + data[0]["nb_hits"] + "</td></tr>");
                                ANOKCO.DATA.ANALYTICS.push([ANOKCO.DATA.urlList[ANOKCO.DATA.urlListCount], data[0]["nb_hits"]]);
                            }
                            //resize the app after adding a line
                            ANOKCO.VIEW.resize();
                            ANOKCO.DATA.urlListCount++;
                            ANOKCO.DATA.getAnalytics();
                        },
                        error: function (xhr, textStatus, errorThrown) {
                            //if there is any error in the process of making the request, show the error
                            //ANOKCO.VIEW.showError(errorThrown);
                            alert("For the URL: " + ANOKCO.DATA.urlList[ANOKCO.DATA.urlListCount] + "\nthis error has occurred: " + errorThrown);
                            ANOKCO.DATA.urlListCount++;
                            ANOKCO.DATA.getAnalytics();
                        }
                    });
                }
            }
        }

        ANOKCO.LOGIC.getMonthName = function (month, longOrShort) {
            var monthNamesShort = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            var monthNamesLong = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            switch (longOrShort) {
                case "long":
                    return monthNamesLong[month];
                    break;
                case "short":
                    return monthNamesShort[month];
                    break;
                default:
                    return "error";
                    break;
            }
        }

        $(document).ready(function () {
            ANOKCO.VIEW.showForm();
            ANOKCO.VIEW.showDropdowns();
            ANOKCO.VIEW.showUrlControls();
            ANOKCO.VIEW.style();
        });
    </script>
</body>
</html>
